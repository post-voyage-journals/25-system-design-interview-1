## Netflix 사례 알아보기

### High-Level 디자인

![Netflix High-Level 시스템 아키텍처](./Netflix-High-Level-System-Architecture.png)

- AWS, Open Connect 2개의 클라우드 상에서 운영됨
- 3개의 핵심 컴포넌트
  - Client
    - 사용자 디바이스
    - 넷플릭스 영상을 시청할 수 있는 장치
  - OC (Open Connect / Netflix)
    - Netflix의 글로벌 CDN을 통해 더욱 빠르게 비디오 전달
    - Open Connect는 Netflix의 사설 CDN
      - ISP 내부 혹은 근처의 OCA(Open Connect Appliance)를 통해 트래픽을 지역화
  - Backend
    - 스트리밍을 제외한 콘텐츠 온보딩, 비디오 처리, 서버 분산, 트래픽 관리 등의 작업 수행
    - 대부분 AWS 서비스들을 활용해서 처리
- MSA 기반 설계
- EVCache/Redis
  - EVCache는 Netflix가 Memcached 기반으로 추가 구현한 캐시 시스템
    - 데이터 복제 및 장애 시 자동 전환 기능 수행

### Use-Case 디자인

**홈 / 개인화**

- 시청 기록, 검색 및 클릭, 평가, 시청 시간대, 사용 기기 등
- 랭킹 시스템 기반으로 예상 시청 항목 우선순위 지정
  - 최신성, 선호도, 다양성 등을 기반으로 순위 계산
- N개 페이지를 구체화해서 프로필별로 캐싱

**검색**

- 텍스트, 언어, 지역과 함께 선호하는 언어, 장르 등도 함께 쿼리
- 사용자의 검색 의도를 존중하기 위해 개인화 가중치를 낮춰야 함

**재생**

- Edge 상태, 프로필 정보, 재생 장치, 대역폭 정보를 받아야 함
- 흐름
  - Authorization
    - 프로필 및 권한 확인
    - DRM 라이센스 생성
  - Edge selection
    - 가장 가까운 정상적인 CDN 선택
    - 트랙 변형이 포함된 Manifest(HLS/DASH) 반환
  - ABR loop client-side
    - 초기 재생은 보수적으로 낮은 성능
    - 모니터링하면서 처리량/버퍼를 점진적으로 up/down
  - Telemetry streaming
    - 비트레이트 전환, 재버퍼링, 오류 처리 등 수행

**다운로드 (오프라인)**

- 흐름
  - 장치 프로필 및 사용자 선택 기반으로 적합한 변형 선택
  - 유효 기간이 있는 오프라인 DRM 라이센스를 생성하고 장치/프로필에 바인딩
  - 네트워크 규칙을 적용해서 백그라운드에서 다운로드
  - 다운로드된 동영상을 재생할 때마다 라이센스 검증 (허용되는 경우 라이센스 재갱신)

### Low-Level 디자인

**비디오 트랜스코딩**

- 2,200개 이상의 디바이스를 지원하기 위해 1,200개 가량의 복제본 생성
- AWS 병렬 워커를 사용해서 복제본을 생성하고 전세계 Open Connect 서버로 전송
- 최적의 스트리밍 품질을 보장하는 프로세스
  - 기기에서 Netflix 접속 시 AWS 인스턴스는 사용 기록 기반 추천, 검색, 고객 지원 등의 서비스 제공
  - 사용자가 비디오 재생 버튼을 누르면 네트워크 연결을 분석해서 최적의 Open Connect 서버 제공

**ZUUL**

- 동적 라우팅, 모니터링, 장애 대응, 보안 등을 제공하는 게이트웨이 서비스
- Netty 서버 기반으로 네트워크 프로토콜, 웹 서버, 연결 관리, 프록시 기능 담당
- 규칙에 따라 트래픽을 여러 서버로 분산하는 기능 수행
- 개발자가 새로 배포된 일부 머신 대상으로 부하 테스트 수행 가능

**Hystrix**

- 서버 간 종속성으로 인한 지연 문제 해결 용도
- 분산 서비스 간 상호 작용 제어
- 분산 시스템에서의 연쇄적 실패 방지
- 실시간 모니터링 및 운영 제어
- 동시성 요청 인식 및 캐싱, 자동 배치 작업을 통해 요청 축소

**Kafka & Apache Chukwa**

- Netflix 시스템에서 생성된 데이터 수집
- Apache Chukwe
  - 분산 시스템에서 로그나 이벤트를 수집하는 오픈소스 데이터 수집 시스템
  - HDFS, MapReduce 기반으로 구축되었음
  - Hadoop의 확장성과 견고성을 제공

**Elastic Search**

- 150여개 Elastic Search 클러스터 및 3,500여개 인스턴스를 갖춘 호스트 운영
- 데이터 시각화, 고객 지원, 시스템 오류 감지를 위해 활용

**Apache Spark**

- 영화 추천을 위해 사용하는 머신러닝 기능
- 개인화 및 콘텐츠 추천 랭킹 생성을 위해 사용됨
