## 설계 요구사항

- 앱, 웹, 스마트 TV 지원
- DAU 500만
  - 인당 평균 30분 동안 서비스 사용
  - 인당 평균 5개 비디오 시청
  - 50만 사용자는 평균 1회 비디오 업로드
- 다국어 지원
- 비디오 최대 크기 1GB
  - 평균 크기 300MB
  - = 매일 150TB 저장

## 구성요소

**Client**

- 모바일, 웹, 스마트 TV를 통해 시청 가능

**CDN**

- 비디오는 CDN에 저장
- 비디오를 캐싱하는 역할
- 사용자가 재생 버튼을 누르면 CDN으로부터 스트리밍

**Load balancer**

- API 요청 시 API 서버들에게 요청을 고르게 분산

**API 서버**

- 비디오 스트리밍을 제외한 모든 요청을 처리
  - 피드 추천
  - 비디오 업로드 URL 생성
  - 메타데이터 DB 및 캐시 갱신
  - 사용자 가입
  - etc

**Metadata DB**

- 비디오의 메타데이터 보관
- sharding 및 replication을 적용해 성능 및 가용성 확보

**Metadata 캐시**

- 비디오 메타데이터 및 사용자 정보 캐시

**원본 저장소**

- 원본 비디오를 보관하는 BLOB 시스템
  - 대형 이진 파일 저장 시스템

**트랜스코딩 서버**

- 비디오 포맷 변환 작업
- 작업 이후 완료 이벤트를 큐에 삽입

**트랜스코딩 비디오 저장소**

- 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- 저장된 비디오를 CDN에도 전송

**트랜스코딩 완료 큐**

- 트랜스코딩 이벤트 완료에 대한 메시지를 담는 큐

**트랜스코딩 완료 핸들러**

- 큐에서 메시지를 꺼내 메타데이터 DB 및 캐시에 반영

## 스트리밍 프로토콜

- MPEG-DASH
  - "Moving Picture Experts Group"
  - "Dynamic Adaptive Streaming over HTTP"
- Apple HLS
  - "HTTP Live Streaming"
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming

---

- 프로토콜들의 이름을 외워두거나 작동 원리를 알 필요는 없음
- 다만 인코딩 및 플레이어가 다르므로 서비스 용례에 맞는 것을 잘 골라야 함

## 비디오 트랜스코딩 기본 개념

- 단말과 호환되는 비트레이트와 포맷으로 저장되어 있어야 함
- 네트워크 대역폭에 따라 저화질 및 고화질 비디오 전송
  - 자동 및 수동 변경 가능하도록
- 인코딩 포맷
  - 컨테이너
    - 비디오, 오디오, 메타데이터 저장
    - .avi, .mov, .mp4 같은 파일 확장자를 통해 구분
  - 코덱
    - 비디오 화질을 보존하면서 파일 크기를 줄이는 압축 및 압축 해제 알고리즘
    - 자주 사용되는 것들: H.264, VP9, HEVC

## DAG(Ditected Acyclic Graph) 모델

- 작업들을 단계별로 배열해서 순차적 또는 병렬적으로 실행될 수 있도록 구성하는 방식
- 선호하는 대로 작업들을 구성할 수 있는 유연성과 병렬성을 확보할 수 있음
- 비디오 관련 Task
  - 검사: 비디오 손상 여부 및 품질 확인
  - 인코딩: 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩
  - 썸네일: 사용자가 업로드한 이미지 혹은 비디오 자동 추출 이미지로 썸네일 생성
  - 워터마크: 비디오 식별 정보를 오버레이 형태로 표시

## 비디오 트랜스코딩 아키텍처

### Preprocessor

- 비디오 분할
  - 비디오 스트림을 GOP(Group of Picture) 단위로 분할
    - 특정 순서로 배열된 프레임 그룹
    - 보통 몇 초 정도이며, 독립적으로 재생 가능
    - 오래된 단말 및 브라우저는 GOP 미지원
- DAG 생성
  - 클라이언트의 설정에 따라 DAG 생성
- 데이터 캐시
  - 분할된 비디오 캐시
  - GOP 및 메타데이터를 임시 저장소에 보관
  - 인코딩 실패 시 캐시를 활용해 인코딩 재시작

### DAG Scheduler

- DAG 그래프를 몇 개의 stage로 나눈 뒤 각각 task queue에 삽입

### Resource Manager

- 자원 배분을 효율화
- 3개의 큐와 task 스케줄러로 구성
  - 작업 큐: 실행할 작업을 보관하는 우선순위 큐
  - 작업 서버 큐: 작업 서버의 가용 상태 정보를 보관하는 우선순위 큐
  - 실행 큐: 현재 실행 중인 작업 및 작업 서버 정보 보관
  - 작업 스케줄러
    - 최적의 작업/서버 조합을 골라서 작업 서버가 작업을 수행하도록 지시
    - 작동 방식
      - 작업 큐에서 우선순위가 가장 높은 작업 폴링
      - 해당 작업 실행을 수행하기에 가장 적합한 서버 폴링
      - 작업 서버에게 작업 실행 지시
      - 작업의 서버 할당 정보를 실행 큐에 삽입
      - 작업 완료 후 해당 작업을 실행 큐에서 제거

### Resource Worker

- DAG에 정의된 작업 수행
- 작업 종류에 따라 작업 서버도 구분하여 관리됨

### Temporary Storage

- 메타데이터는 메모리에 캐시
- 비디오/오디오 데이터는 BLOB 저장소에 저장
- 임시 저장소의 데이터는 비디오 프로세싱 완료 후 삭제

## 속도 최적화

- 비디오 병렬 업로드
  - GOP 분할 후 업로드
- 업로드 센터 분산
  - 다양한 지역에 업로드 센터를 배치해서 되도록 근거리에 저장되게 할 것
- 모든 절차를 병렬화
  - MQ를 도입해 대기 과정 최소화

## 안정성 최적화

- pre-signed url
  - 인증 받은 사용자만 저장소에 업로드 허용
  - 업로드 전에 POST 요청을 통해 pre-signed url을 먼저 획득하도록 강제하는 방식
- 비디오 원본 보호
  - DRM(Digital Rights Management) 시스템 도입
  - AES 암호화
    - 비디오 암호화 및 접근 권한 설정
    - 암호화된 비디오는 재생 시에만 복호화
    - 허용된 사용자만 암호화된 비디오 시청 가능
  - 워터마크

## 비용 최적화

- 인기 비디오만 CDN 저장
  - 나머지 비디오는 비디오 서버를 통해 재생
- 인기가 별로 없고, 짧은 비디오라면 인코딩 X
  - 재생 시점에 인코딩해서 재생
- 지역별 인기 비디오 관리
  - 다른 지역에도 굳이 옮겨둘 필요가 없음
- CDN 직접 구축 및 ISP와 제휴
