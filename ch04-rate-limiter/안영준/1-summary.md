## 1. 챕터 요약

- 처리율 제한 장치의 위치

| 클라이언트 | 서버 |
| --- | --- |
| x (쉽게 변조해서 주로 쓰지 않음) | 처리율 제한 장치 미들웨어 (api gateway) |
- 주로 사용되는 알고리즘
    - 토큰 버킷 : 일정 시간마다 토큰이 충전됨. 요청이 들어오면 토큰을 소비함.
    - 누출 버킷:  크기가 정해진 큐에 저장함. 일정 시간마다 토큰을 소비함. 가득 찼으면 버림.
    - 고정 윈도 카운터:  일정 시간마다 윈도를 나누고 그 윈도마다 카운터를 셈.
    - 이동 윈도 로그: 새 요청이 오면 만료된 타임스탬프는 제거됨. 만약 일정 시간 내 정해진 양보다 많이 들어오면 요청은 무시되지만 타임스탬프는 기록됨.
    - 이동 윈도 카운터:  이전 시간대의 평균 처리율에 따라 현재 윈도의 상태를  계산함. 
    현재 1분간 요청 수 + 직전 1분간의 요청 수 * (100% - 현재 1분간 이동된 윈도)
- 카운트 보관 장소
    - 중앙 집중형 데이터 저장소가 주로 사용됨.
    고정 세션(같은 사용자는 같은 저장소) 가 고려되지 않는 이유는 확장이 어렵고, 유연이 어려움. 
    (개인적으로는 처음에 설명되었던 데이터들 간의 접근도 차이가 공평하게 이루어지지 않을 확률이 크다고 생각함. 또한 굳이 고정 세션을 사용할 필요는 없는 것이 중앙 집중형 데이터 저장소에서 샤딩을 이용하면 된다고 생각함.)
- 성능 최적화
    - 엣지 서버: 사용자의 트래픽을 가장 가까운 에지 서버로 전달하여 지연시간 줄임.
- else
    - 경성 또는 연성 처리율 제한:
        - 경성 제한 → `429 Too Many Requests` 즉시 반환
        - 연성 제한 → “Throttle” 헤더나 `Retry-After` 응답으로 클라이언트에게 대기 요청 또는 점진적으로 응답 지연 (`sleep`, `queue` 등)
    - 다양한 계층에 대한 처리율 제한:
        - 1~3계층 (네트워크) 방화벽, 라우터 - IP 주소, 포트, 연결 수
        - 4계층 (전송) Load Balancer - TCP 연결 수, 초당 패킷 수
    - 처리율 제한 회피:
        - 클라이언트측 캐시 이용

## 2. 허점 (Critic)

- 중앙 집중형 저장소 의존:
    - 처리율 카운트를 중앙 저장소에 의존하면 저장소 장애 시 전체 제한 기능이 마비됨.
    - 샤딩을 하더라도 네트워크 지연이나 동기화 문제로 정확도가 떨어질 수 있음.
- 비로그인 사용자 처리율 제한 방법
    - NAT, VPN, 공유 IP 환경에서는 정확도 낮음.
    - 브라우저 변경/쿠키 삭제 시 회피 가능

## 3. 개선 방안 (Improver)

- 단일 서버 대신 Redis Cluster, Cassandra, DynamoDB 같은 분산형 데이터 저장소 사용
    - 분산 환경에서는 동시성 보장을 위해 원자적 연산 또는 트랜잭션 필요 (예: Redis Lua 스크립트)

## 4. 최종 아키텍처

```
    +----------------+
    |    클라이언트    |
    +----------------+
             |
             v
    +----------------+
    | API Gateway /  |
    | 처리율 제한 MW |
    +----------------+
             |
             v
    +--------------------------+
    | 분산형 데이터 저장소      |
    | (Redis Cluster, Cassandra)|
    +--------------------------+

```

## 5. 실무 적용 인사이트

- 보안 검사를 하다가 dos 취약점을 받아. 급하게 추가해야 할 일이 있어 미들웨어에 ip와 유저(uuid and 쿠키/세션) 기반으로 redis를 통해 제한을 두었다.

## 6. 모의 꼬리 질문

- 비로그인 사용자 처리율 제한 방법?
    - IP → NAT, VPN, 공유 IP 환경에서는 정확도 낮음. 해결방법?
    - 쿠키 → 브라우저 변경/쿠키 삭제 시 회피 가능?