## 설계 요구사항

- soft real-time 시스템
  - 알림은 가능한 한 빨리 전달되어야 하지만 부하 상태일 때 약간의 지연은 허용
- 하루 1,000만 건 모바일 푸시 알림, 100만 건 SMS 메시지, 500만 건 이메일 전송

## 설계 및 구현

### 알림 유형별 지원 방안

- iOS: Provider → APNS(Apple Push Notification Server) → iOS device
- Android: Provider → FCM(Firebase Cloud Message) → Android device
- SMS: Provider → 3rd party service(Twilio, Nexmo, ...) → Device
- Email: Provider → 3rd party service(Sendgrid, Mailchimp, ...) → Device

### 연락처 정보 수집 절차

- 알림을 보내기 위해 단말 토큰, 전화번호, 이메일 주소 등의 정보 필요
- 최초 계정 등록 시 API 서버는 사용자 정보를 DB에 저장

### 알림 전송 플로우

1. API를 호출해서 알림 서버로 알림 전송
2. 알림 서버는 알림 전송을 위한 메타데이터를 캐시 혹은 DB로부터 조회
3. 알림 서버는 알림 이벤트를 만들어서 전송 디바이스 대상 큐에 삽입
4. 작업 서버는 MQ에서 알림 이벤트를 꺼내고, 알림을 3rd 파티 서비스로 전송
5. 3rd 파티 서비스는 디바이스로 알림 전송

## 상세 설계

### 데이터 손실 방지

- 알림 지연, 순서 섞임은 큰 상관 없지만 메시지 유실에는 대비해야 함
- Notification Log DB를 유지하는 것이 한 가지 방법

### 알림 중복 전송 방지

- 분산 시스템 특성상 알림 중복을 완전히 막을 순 없음
- 이벤트 ID를 검사하는 식으로 중복 빈도를 낮출 수는 있을 것

### 알림 템플릿

- 파라미터, 스타일, 추적 링크 정도만 조정하게끔 형식을 정해두는 틀

### 전송률 제한

- 한 사용자에게 너무 많은 알림을 보내지 않도록 알림 빈도 제한을 둘 수 있음
- 사용자가 알림을 끄지 않게 할 수 있는 중요한 기능

### 재시도

- 3rd 파티 서비스의 알림 전송 실패 시 알림을 재시도 전용 큐에 삽입
- 재시도해도 해결이 안 되면 alert을 통해 개발자에게 알림
