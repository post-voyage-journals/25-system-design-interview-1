## 분산 환경에서 데이터를 어떻게 분배하는가?

- 수평적 규모 확장을 위해 데이터를 서버에 균등하게 나눠야 함
- **안정 해시**는 이를 달성하기 위해 보편적으로 사용되고 있는 기술

## 모듈로 연산 방식

```js
serverIndex = hash(key) % N
```

- N개의 서버들에게 부하를 균등하게 나누는 보편적인 방법
- 하지만 서버 추가 혹은 삭제 발생 후 재분배 작업에서 키가 뷸균등하게 재배치될 수 있음

⇒ **안정 해시**는 이러한 문제를 해결하기 위해 나온 기술

## 안정 해시 (기본 구현 방식)

- 정의: 해시 테이블의 크기가 조정될 때 평균적으로 `k/n`개의 키만 재배치하는 해시 기술
- 용어 정리
  - 해시 공간: 해시 함수(SHA, MD 등)가 가질 수 있는 해시 값의 전체 범위
  - 해시 링: 해시 공간을 원 모양으로 구부려서 가시적으로 표현한 형태
  - 해시 서버: 서버의 IP 혹은 이름 등을 해시 링 위에 배치시켜서 표현
  - 해시 키: 캐시할 키를 해시 링 위에 배치시켜서 표현
- 키의 위치로부터 시계 방향으로 해시 링을 탐색할 때, 처음으로 만난 서버가 키가 저장될 서버가 되는 방식
- 서버 및 키는 균등 분포(uniform distribution) 해시 함수를 사용해서 해시 링 위에 배치

기본 구현 방식의 문제점

1. 파티션 크기를 균등하게 유지하는 것이 불가능
2. 키의 균등 분포 달성이 어려움

## 가상 노드 방식

- 안정 해시의 문제점을 보강하기 위해, 실제 노드를 가리키는 가상 노드를 추가로 배치하는 방식
- 하나의 서버는 여러 가상 노드를 가질 수 있고, 따라서 각 서버는 여러 개의 파티션을 관리하게 됨
- 가상 노드 개수를 늘릴수록 표준 편차는 작아지고 키 분포는 더욱 균등해짐
- 하지만 가상 노드 데이터를 저장할 공간도 필요해지므로 트레이드오프를 고려해야 함

## 안정 해시의 장점

- 서버 추가 및 삭제 시 재배치되는 키의 수 최소화
- 데이터를 균등하게 배포함으로써 수평적 규모 확장성 달성
- 핫스팟 키 문제 축소

## 안정 해시 실제 활용 사례

- Amazon DynamoDB 파티셔닝 관련 컴포넌트
- Apache Cassandra 클러스터에서의 데이터 파티셔닝
- Discord 채팅 애플리케이션
- Akami CDN
- Meglev 네트워크 부하 분산기
